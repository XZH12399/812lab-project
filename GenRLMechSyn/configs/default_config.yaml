# configs/default_config.yaml

project_name: "GenRLMechSyn"
timestamp: "20251127"

# --- 1. 数据集设置 ---
data:
  # 初始数据集 (建议指向你新生成的 2-DOF 8-Bar 数据集)
  initial_manifest_path: "data/initial_2dof_dataset/metadata.json"
  # 增强数据集 (用于存放生成并通过评估的高分机构)
  augmented_manifest_path: "data/augmented_dataset/metadata.json"

  # [关键] 最大节点数 (对于 8杆机构必须设为 8)
  max_nodes: 8

  # 全局标签映射表
  #在此处统一定义所有支持的机构类型及其 ID
  label_mapping:
    "bennett": 0
    "general_2dof": 1
    # 未来可以添加: "rccc": 2, "spherical": 3 ...

  # 归一化参数 (按物理最大值设定)
  normalization_values:
    a: 20.0       # 连杆长度最大值
    alpha: 3.1416 # 扭转角最大值 (pi)
    d: 20.0       # 偏移量最大值

# --- 2. 训练参数 ---
training:
  # DiT 预热 (建议 50-100 轮)
  dit_warmup_epochs: 50
  # RL 预热
  rl_warmup_epochs: 50

  # 主循环
  num_cycles: 300
  epochs_per_cycle: 50
  batch_size: 8

  learning_rate: 0.0001
  rl_learning_rate: 0.00001

  device: "cuda"
  replay_buffer_limit: 10000
  random_seed: 42

  # 检查点保存
  save_checkpoint_path: "checkpoints/training_checkpoint.pth"
  load_checkpoint_path: null # 设为路径以恢复训练

  # 开关
  enable_rl_guidance: true
  enable_augmentation: true

# --- 3. 扩散模型参数 (DiT) ---
diffusion_model:
  # 图像尺寸必须与 data.max_nodes 一致
  img_size: 8
  patch_size: 2      # 8 可以被 2 整除
  in_channels: 5     # [exists, joint_type, a, alpha, offset]

  embed_dim: 768
  depth: 12
  num_heads: 12

  timesteps: 1000
  schedule_type: "cosine"

  # 类别数 (0: Bennett, 1: General 2-DOF)
  num_classes: 2

# --- 4. 生成与优化器参数 ---
generation:
  num_to_generate: 50

  # 目标标签索引 (0: bennett, 1: general_2dof)
  target_label_index: 1

  # [优化器] 软优化判定阈值 (Loss低于此值才算 OK)
  optimization_tolerance: 0.01

  # [优化器] 多重启动次数 (应对非凸优化)
  num_restarts: 1

  # [优化器] 末端节点索引 (EE Node)
  # 指定哪个关节是末端平台的"入口"。
  # 对于 8-Bar (0->...->7)，通常设为 7。如果不填，默认取 max_nodes - 1。
#  ee_node: 7

  # Evaluator 的硬性录取分数线 (Score >= threshold 才能进入增强数据集)
  acceptance_threshold: 3.98
  rl_guidance_scale: 1.0

# --- 5. 评估器与优化目标配置 ---
evaluator_config:

  # === 通用指标 (适用于所有机构) ===
  common_indicators:

    # A. 闭环位置可行性 (最基础要求)
    check_kinematic_feasibility:
      enable: true
      weight: 1.0

    # B. 可动性检查 (防止死锁)
    check_mobility:
      enable: true
      weight: 1.0
      threshold: 0.001 # 评估器用的 SVD/Eigen 阈值 (判定是否为0)
      # 谱间隙阈值 (优化器用)
      # 强迫第 K+1 个特征值大于此值，防止自由度过多 (秩亏过量)
      # 建议值: 0.005 ~ 0.01
      gap_threshold: 0.005

    # C. 任务性能检查 (Task Performance)
    # [核心] 定义你想要的运动类型 (如 2T, 3T, 1T1R)
    check_task_performance:
      enable: true   # 开启后，优化器会寻找满足这些模式的解
      weight: 1.0    # 强约束权重

      # 目标运动模式列表 (Target Motion Patterns)
      # 格式: [wx, wy, wz, vx, vy, vz]
      # 使用数值强制约束，使用 null (None) 表示不关心该维度
      target_motion_patterns:
        # 自由度 1: 纯 X 轴移动 (无转动)
        - [0.0, 0.0, 0.0, 1.0, 0.0, 0.0]

        # 自由度 2: 纯 Y 轴移动 (无转动)
        - [0.0, 0.0, 0.0, 0.0, 1.0, 0.0]

    check_global_consistency:
      enable: true
      weight: 1.0        # 在 Optimizer 中的权重，以及 Evaluator 评分的权重
      threshold: 0.05    # Evaluator 中的容忍阈值

  # === 特定标签指标 (仅当 target_label 匹配时生效) ===
  label_specific_indicators:

    # Bennett 机构专用配置
    "bennett":
      check_is_bennett:
        enable: false
        weight: 1.0 # 优化器中会自动放大 20 倍
        existence_threshold: 0.05
        bennett_error_threshold: 0.1

      # 如果是 Bennett 任务，通常不需要 Task Performance (设为 false)
      # 可以在代码逻辑中自动处理，或者在这里手动覆盖 common_indicators

    # 通用 2自由度机构
    "general_2dof":
      # 这里可以添加其他特定检查，目前主要依靠 common_indicators 中的 Task 检查
      check_topology_similarity:
        enable: false
        weight: 0.0